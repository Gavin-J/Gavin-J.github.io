<!DOCTYPE html><html><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="docker环境的搭建(离线安装)"><meta name="keywords" content="docker"><meta name="author" content="GuoJing,undefined"><meta name="copyright" content="GuoJing"><title>docker环境的搭建(离线安装) | 锦瑟年华</title><link rel="shortcut icon" href="/my-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/gh/upupming/gitalk@36368e5dffd049e956cdbbd751ff96c28d8255cf/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-离线环境下安装docker-ce"><span class="toc-number">1.</span> <span class="toc-text">1. 离线环境下安装docker-ce</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-卸载老的docker环境"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 卸载老的docker环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-下载离线安装包"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 下载离线安装包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-启动docker"><span class="toc-number">1.3.</span> <span class="toc-text">1.3 启动docker</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-docker启动配置"><span class="toc-number">2.</span> <span class="toc-text">2. docker启动配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1）-设置docker开机自动启动"><span class="toc-number">2.1.</span> <span class="toc-text">1） 设置docker开机自动启动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2）-配置开放管理端口映射"><span class="toc-number">2.2.</span> <span class="toc-text">2） 配置开放管理端口映射</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-搭建私有镜像仓库"><span class="toc-number">3.</span> <span class="toc-text">3. 搭建私有镜像仓库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-下载私有镜像仓库"><span class="toc-number">3.1.</span> <span class="toc-text">1) 下载私有镜像仓库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-安装registry镜像仓库"><span class="toc-number">3.2.</span> <span class="toc-text">2) 安装registry镜像仓库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-为镜像仓库挂载一块硬盘"><span class="toc-number">3.3.</span> <span class="toc-text">3) 为镜像仓库挂载一块硬盘</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-设置开机自动启动私有镜像仓库"><span class="toc-number">3.4.</span> <span class="toc-text">4) 设置开机自动启动私有镜像仓库</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-测试"><span class="toc-number">4.</span> <span class="toc-text">3. 测试</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-push镜像到私有镜像仓库"><span class="toc-number">4.1.</span> <span class="toc-text">1) push镜像到私有镜像仓库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2）-配置docker以支持http方式push"><span class="toc-number">4.2.</span> <span class="toc-text">2） 配置docker以支持http方式push</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3）-查看我们push到私有镜像仓库中的镜像"><span class="toc-number">4.3.</span> <span class="toc-text">3） 查看我们push到私有镜像仓库中的镜像</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-配置仓库认证"><span class="toc-number">5.</span> <span class="toc-text">4. 配置仓库认证</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-删除原来启动的仓库容器"><span class="toc-number">5.1.</span> <span class="toc-text">1) 删除原来启动的仓库容器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-创建存放账号的文件"><span class="toc-number">5.2.</span> <span class="toc-text">2) 创建存放账号的文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-修改docker-registry的启动参数，并启动"><span class="toc-number">5.3.</span> <span class="toc-text">3) 修改docker registry的启动参数，并启动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-测试"><span class="toc-number">5.4.</span> <span class="toc-text">4) 测试</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://www.guojing-em.com/static/resume/images/guojing-image.png"></div><div class="author-info__name text-center">GuoJing</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/Gavin-J" target="_blank">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">15</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">10</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://s1.ax1x.com/2018/05/17/C6dsg0.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">锦瑟年华</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">docker环境的搭建(离线安装)</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-11-25</time><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">3,955</span><span class="post-meta__separator">|</span><span>Reading time: 21 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>本文介绍在CentOs7.3操作系统上，docker离线环境下的安装。</p>
<h1 id="1-离线环境下安装docker-ce"><a href="#1-离线环境下安装docker-ce" class="headerlink" title="1. 离线环境下安装docker-ce"></a>1. 离线环境下安装docker-ce</h1><p>当前操作系统版本：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@docker-registry docker]# cat /etc/centos-release</span><br><span class="line">CentOS Linux release 7.3.1611 (Core) </span><br><span class="line">[root@docker-registry docker]# uname -a</span><br><span class="line">Linux docker-registry 3.10.0-514.el7.x86_64 #1 SMP Tue Nov 22 16:42:41 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux</span><br></pre></td></tr></table></figure></p>
<a id="more"></a>
<h2 id="1-1-卸载老的docker环境"><a href="#1-1-卸载老的docker环境" class="headerlink" title="1.1 卸载老的docker环境"></a>1.1 卸载老的docker环境</h2><p>这里首先卸载老版本的docker环境：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># yum remove docker*</span><br><span class="line"># yum list installed | grep &quot;container&quot;   //卸载相关组件container-selinux（必须卸载，不然会报冲突的错误）</span><br><span class="line">container-selinux.noarch               2:2.36-1.gitff95335.el7         installed</span><br><span class="line"># yum remove container-selinux.noarch</span><br></pre></td></tr></table></figure></p>
<h2 id="1-2-下载离线安装包"><a href="#1-2-下载离线安装包" class="headerlink" title="1.2 下载离线安装包"></a>1.2 下载离线安装包</h2><p>先找一台与当前CentOS版本相同（相似）的主机，通过该主机来下载docker-ce安装包。首先配置yum源:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># wget https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line"># cp docker-ce.repo /etc/yum.repos.d/</span><br><span class="line">docker官方下载地址：https://download.docker.com/</span><br></pre></td></tr></table></figure></p>
<p>下载docker-ce安装包及其依赖包：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># yum clean packages            </span><br><span class="line"># yum clean all</span><br><span class="line"># yum repolist</span><br><span class="line"># yum makecache</span><br><span class="line"></span><br><span class="line"># yum list docker-ce --showduplicates</span><br><span class="line">Loaded plugins: fastestmirror, langpacks</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * base: centos.ustc.edu.cn</span><br><span class="line"> * extras: mirror.lzu.edu.cn</span><br><span class="line"> * updates: mirror.lzu.edu.cn</span><br><span class="line">Installed Packages</span><br><span class="line">docker-ce.x86_64                                                          17.12.1.ce-1.el7.centos                                                          installed       </span><br><span class="line">Available Packages</span><br><span class="line">docker-ce.x86_64                                                          17.03.0.ce-1.el7.centos                                                          docker-ce-stable</span><br><span class="line">docker-ce.x86_64                                                          17.03.1.ce-1.el7.centos                                                          docker-ce-stable</span><br><span class="line">docker-ce.x86_64                                                          17.03.2.ce-1.el7.centos                                                          docker-ce-stable</span><br><span class="line">docker-ce.x86_64                                                          17.06.0.ce-1.el7.centos                                                          docker-ce-stable</span><br><span class="line">docker-ce.x86_64                                                          17.06.1.ce-1.el7.centos                                                          docker-ce-stable</span><br><span class="line">docker-ce.x86_64                                                          17.06.2.ce-1.el7.centos                                                          docker-ce-stable</span><br><span class="line">docker-ce.x86_64                                                          17.09.0.ce-1.el7.centos                                                          docker-ce-stable</span><br><span class="line">docker-ce.x86_64                                                          17.09.1.ce-1.el7.centos                                                          docker-ce-stable</span><br><span class="line">docker-ce.x86_64                                                          17.12.0.ce-1.el7.centos                                                          docker-ce-stable</span><br><span class="line">docker-ce.x86_64                                                          17.12.1.ce-1.el7.centos                                                          docker-ce-stable</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># sudo yum install --downloadonly --downloaddir=./ docker-ce-17.12.0.ce-1.el7.centos</span><br></pre></td></tr></table></figure></p>
<p>另外还会依赖于libltdl.so.7()(64bit)与libseccomp.so.2()(64bit)，可以按如下方式下载：</p>
<p>//通过如下方法查看rpm包的依赖关系<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"># rpm -qpR ./docker-ce-17.12.0.ce-1.el7.centos.x86_64.rpm </span><br><span class="line">warning: ./docker-ce-17.12.0.ce-1.el7.centos.x86_64.rpm: Header V4 RSA/SHA512 Signature, key ID 621e9f35: NOKEY</span><br><span class="line">/bin/sh</span><br><span class="line">/bin/sh</span><br><span class="line">/bin/sh</span><br><span class="line">/bin/sh</span><br><span class="line">/bin/sh</span><br><span class="line">/bin/sh</span><br><span class="line">container-selinux &gt;= 2.9</span><br><span class="line">device-mapper-libs &gt;= 1.02.90-1</span><br><span class="line">iptables</span><br><span class="line">libc.so.6()(64bit)</span><br><span class="line">libc.so.6(GLIBC_2.14)(64bit)</span><br><span class="line">libc.so.6(GLIBC_2.17)(64bit)</span><br><span class="line">libc.so.6(GLIBC_2.2.5)(64bit)</span><br><span class="line">libc.so.6(GLIBC_2.3)(64bit)</span><br><span class="line">libc.so.6(GLIBC_2.4)(64bit)</span><br><span class="line">libcgroup</span><br><span class="line">libdevmapper.so.1.02()(64bit)</span><br><span class="line">libdevmapper.so.1.02(Base)(64bit)</span><br><span class="line">libdevmapper.so.1.02(DM_1_02_97)(64bit)</span><br><span class="line">libdl.so.2()(64bit)</span><br><span class="line">libdl.so.2(GLIBC_2.2.5)(64bit)</span><br><span class="line">libltdl.so.7()(64bit)</span><br><span class="line">libpthread.so.0()(64bit)</span><br><span class="line">libpthread.so.0(GLIBC_2.2.5)(64bit)</span><br><span class="line">libpthread.so.0(GLIBC_2.3.2)(64bit)</span><br><span class="line">libseccomp.so.2()(64bit)</span><br><span class="line">libsystemd.so.0()(64bit)</span><br><span class="line">libsystemd.so.0(LIBSYSTEMD_209)(64bit)</span><br><span class="line">rpmlib(CompressedFileNames) &lt;= 3.0.4-1</span><br><span class="line">rpmlib(FileDigests) &lt;= 4.6.0-1</span><br><span class="line">rpmlib(PayloadFilesHavePrefix) &lt;= 4.0-1</span><br><span class="line">rtld(GNU_HASH)</span><br><span class="line">systemd-units</span><br><span class="line">tar</span><br><span class="line">xz</span><br><span class="line">rpmlib(PayloadIsXz) &lt;= 5.2-1</span><br><span class="line"></span><br><span class="line"># yum deplist docker-ce              //此种方法也能查看依赖包</span><br><span class="line"># yumdownloader &lt;package-name&gt;       //用此下载指定名称的包</span><br><span class="line"></span><br><span class="line">//http://rpmfind.net/linux/rpm2html/search.php?query=libltdl.so.7()(64bit)</span><br><span class="line"># wget http://rpmfind.net/linux/centos/7.4.1708/os/x86_64/Packages/libtool-ltdl-2.4.2-22.el7_3.x86_64.rpm</span><br><span class="line"></span><br><span class="line">//http://www.rpmfind.net/linux/rpm2html/search.php?query=libseccomp.so.2()(64bit)</span><br><span class="line"># wget http://www.rpmfind.net/linux/centos/7.4.1708/os/x86_64/Packages/libseccomp-2.3.1-3.el7.x86_64.rpm</span><br></pre></td></tr></table></figure></p>
<p>下载完成后，拷贝到对应的离线主机上进行安装：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># yum localinstall *.rpm</span><br></pre></td></tr></table></figure></p>
<h2 id="1-3-启动docker"><a href="#1-3-启动docker" class="headerlink" title="1.3 启动docker"></a>1.3 启动docker</h2><p>通过如下命令启动docker:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># systemctl start docker</span><br><span class="line"># ps -ef | grep docker</span><br><span class="line">root     10904     1  0 15:13 ?        00:00:03 /usr/bin/dockerd</span><br><span class="line">root     10911 10904  0 15:13 ?        00:00:03 docker-containerd --config /var/run/docker/containerd/containerd.toml</span><br></pre></td></tr></table></figure></p>
<h1 id="2-docker启动配置"><a href="#2-docker启动配置" class="headerlink" title="2. docker启动配置"></a>2. docker启动配置</h1><h2 id="1）-设置docker开机自动启动"><a href="#1）-设置docker开机自动启动" class="headerlink" title="1） 设置docker开机自动启动"></a>1） 设置docker开机自动启动</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># systemctl enable docker</span><br></pre></td></tr></table></figure>
<h2 id="2）-配置开放管理端口映射"><a href="#2）-配置开放管理端口映射" class="headerlink" title="2） 配置开放管理端口映射"></a>2） 配置开放管理端口映射</h2><p>管理端口在 /lib/systemd/system/docker.service 文件中：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network-online.target firewalld.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line"># the default is not to use systemd for cgroups because the delegate issues still</span><br><span class="line"># exists and systemd currently does not support the cgroup feature set required</span><br><span class="line"># for containers run by docker</span><br><span class="line">ExecStart=/usr/bin/dockerd</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line"># Having non-zero Limit*s causes performance problems due to accounting overhead</span><br><span class="line"># in the kernel. We recommend using cgroups to do container-local accounting.</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line"># Uncomment TasksMax if your systemd version supports it.</span><br><span class="line"># Only systemd 226 and above support this version.</span><br><span class="line">#TasksMax=infinity</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line"># set delegate yes so that systemd does not reset the cgroups of docker containers</span><br><span class="line">Delegate=yes</span><br><span class="line"># kill only the docker process, not all processes in the cgroup</span><br><span class="line">KillMode=process</span><br><span class="line"># restart the docker process if it exits prematurely</span><br><span class="line">Restart=on-failure</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure></p>
<p>将上面的ExecStart=/usr/bin/dockerd 替换为：</p>
<p>ExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2375 -H unix://var/run/docker.sock -H tcp://0.0.0.0:7654<br>（此处默认2375为主管理端口，unix:///var/run/docker.sock用于本地管理，7654是备用的端口）</p>
<p>配置完成之后，重新启动：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># systemctl daemon-reload &amp;&amp; systemctl restart docker</span><br></pre></td></tr></table></figure>
<p>//查看docker进程，发现docker守护进程在已经监听2375的tcp端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># ps -ef | grep docker</span><br><span class="line">root      9431     1  0 20:30 ?        00:00:00 /usr/bin/dockerd -H tcp://0.0.0.0:2375 -H unix://var/run/docker.sock -H tcp://0.0.0.0:7654</span><br><span class="line">root      9438  9431  0 20:30 ?        00:00:00 docker-containerd --config /var/run/docker/containerd/containerd.toml</span><br></pre></td></tr></table></figure>
<p>//查看系统的网络端口，发现tcp的2375端口，的确是docker的守护进程在监听</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># netstat -nlp | grep docker</span><br><span class="line">tcp6       0      0 :::7654                 :::*                    LISTEN      9431/dockerd        </span><br><span class="line">tcp6       0      0 :::2375                 :::*                    LISTEN      9431/dockerd        </span><br><span class="line">unix  2      [ ACC ]     STREAM     LISTENING     30464    9431/dockerd         /run/docker/libnetwork/a83e1600984942bbacfc8587ff54aee0625550bb918af4a05ed26ba9a1eed24d.sock</span><br><span class="line">unix  2      [ ACC ]     STREAM     LISTENING     31763    9431/dockerd         var/run/docker.sock</span><br><span class="line">unix  2      [ ACC ]     STREAM     LISTENING     31770    9431/dockerd         /var/run/docker/metrics.sock</span><br><span class="line">unix  2      [ ACC ]     STREAM     LISTENING     30455    9438/docker-contain  /var/run/docker/containerd/docker-containerd-debug.sock</span><br><span class="line">unix  2      [ ACC ]     STREAM     LISTENING     30457    9438/docker-contain  /var/run/docker/containerd/docker-containerd.sock</span><br></pre></td></tr></table></figure>
<h1 id="3-搭建私有镜像仓库"><a href="#3-搭建私有镜像仓库" class="headerlink" title="3. 搭建私有镜像仓库"></a>3. 搭建私有镜像仓库</h1><p>我们当前私有镜像仓库搭建在：10.17.153.196。</p>
<h2 id="1-下载私有镜像仓库"><a href="#1-下载私有镜像仓库" class="headerlink" title="1) 下载私有镜像仓库"></a>1) 下载私有镜像仓库</h2><p>可以到如下两个地址：</p>
<ol>
<li><a href="https://hub.docker.com/explore/" target="_blank" rel="noopener">https://hub.docker.com/explore/</a></li>
<li><a href="https://store.docker.com/" target="_blank" rel="noopener">https://store.docker.com/</a><br>去看一下当前官方仓库镜像。通过如下命令下载：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"># docker search registry</span><br><span class="line">NAME                                    DESCRIPTION                                     STARS               OFFICIAL            AUTOMATED</span><br><span class="line">registry                                The Docker Registry 2.0 implementation for s…   1903                [OK]                </span><br><span class="line">konradkleine/docker-registry-frontend   Browse and modify your Docker registry in a …   181                                     [OK]</span><br><span class="line">hyper/docker-registry-web               Web UI, authentication service and event rec…   126                                     [OK]</span><br><span class="line">atcol/docker-registry-ui                A web UI for easy private/local Docker Regis…   98                                      [OK]</span><br><span class="line">distribution/registry                   WARNING: NOT the registry official image!!! …   54                                      [OK]</span><br><span class="line">marvambass/nginx-registry-proxy         Docker Registry Reverse Proxy with Basic Aut…   43                                      [OK]</span><br><span class="line">google/docker-registry                  Docker Registry w/ Google Cloud Storage driv…   32                                      </span><br><span class="line">jhipster/jhipster-registry              JHipster Registry, based on Netflix Eureka a…   22                                      [OK]</span><br><span class="line">confluentinc/cp-schema-registry         Official Confluent Docker Images for Schema …   16                                      </span><br><span class="line">deis/registry                           Docker image registry for the Deis open sour…   12                                      </span><br><span class="line">openshift/origin-docker-registry        The integrated OpenShift V3 registry            8                                       </span><br><span class="line">joxit/docker-registry-ui                Docker registry v2 web User Interface           6                                       [OK]</span><br><span class="line">landoop/schema-registry-ui              UI for Confluent&apos;s Schema Registry              5                                       [OK]</span><br><span class="line">cblomart/rpi-registry                   docker registry 2 for raspbery pi               5                                       </span><br><span class="line">elasticio/docker-registry-ecs           Docker image to run Docker private registry …   4                                       [OK]</span><br><span class="line">allingeek/registry                      A specialization of registry:2 configured fo…   4                                       [OK]</span><br><span class="line">pallet/registry-swift                   Add swift storage support to the official do…   4                                       [OK]</span><br><span class="line">aibaars/docker-registry2-gcs            Docker Registry2 w/ Google Cloud Storage dri…   1                                       </span><br><span class="line">webhippie/registry                      Docker images for registry                      1                                       [OK]</span><br><span class="line">conjurinc/registry-oauth-server         Docker registry authn/authz server backed by…   1                                       </span><br><span class="line">metadata/registry                       Metadata Registry is a tool which helps you …   1                                       [OK]</span><br><span class="line">convox/registry                                                                         0                                       </span><br><span class="line">kontena/registry                        Kontena Registry                                0                                       </span><br><span class="line">lorieri/registry-ceph                   Ceph Rados Gateway (and any other S3 compati…   0                                       </span><br><span class="line">databus23/docker-registry-proxy         A ssl enabled nginx reverse proxy for the do…   0  </span><br><span class="line"></span><br><span class="line"># docker pull registry</span><br><span class="line"># docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">registry            latest              d1fd7d86a825        8 weeks ago         33.3MB</span><br><span class="line"></span><br><span class="line"># docker tag registry registry:2.6.2      //因为当前registry最新版本是2.6.2，这里我们将其打上tag，以方便后续辨别</span><br><span class="line"># docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">registry            2.6.2               d1fd7d86a825        8 weeks ago         33.3MB</span><br><span class="line">registry            latest              d1fd7d86a825        8 weeks ago         33.3MB</span><br><span class="line"></span><br><span class="line"># docker save -o registry-2.6.2.tar.gz registry:2.6.2       //打包</span><br><span class="line"></span><br><span class="line"># ls </span><br><span class="line">registry-2.6.2.tar.gz</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>然后将上述打包好的镜像仓库拷贝到对应的安装机器上。</p>
<h2 id="2-安装registry镜像仓库"><a href="#2-安装registry镜像仓库" class="headerlink" title="2) 安装registry镜像仓库"></a>2) 安装registry镜像仓库</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># docker load -i registry-2.6.2.tar.gz</span><br><span class="line"># docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">registry            2.6.2               3ebefe7c539b        5 months ago        33.2MB</span><br></pre></td></tr></table></figure>
<h2 id="3-为镜像仓库挂载一块硬盘"><a href="#3-为镜像仓库挂载一块硬盘" class="headerlink" title="3) 为镜像仓库挂载一块硬盘"></a>3) 为镜像仓库挂载一块硬盘</h2><p>如下先将一块硬盘格式化，然后挂载到我们指定的目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># lsblk         </span><br><span class="line"># mkfs.ext4 /dev/vdb</span><br><span class="line"># mkdir /opt/docker-registry</span><br><span class="line"># mount -t ext4 /dev/vdb /registry</span><br><span class="line"></span><br><span class="line"># blkid</span><br><span class="line">/dev/sr0: UUID=&quot;2018-03-09-10-24-55-00&quot; LABEL=&quot;config-2&quot; TYPE=&quot;iso9660&quot; </span><br><span class="line">/dev/vda1: UUID=&quot;f31c1eba-0729-4c4a-959f-d1bb6a2623aa&quot; TYPE=&quot;ext4&quot; </span><br><span class="line">/dev/vdb: UUID=&quot;639cc105-d6a9-43af-8036-3462b450ea5c&quot; TYPE=&quot;ext4&quot;</span><br></pre></td></tr></table></figure></p>
<p>然后在操作系统/etc/fstab文件中添加如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UUID=639cc105-d6a9-43af-8036-3462b450ea5c /opt/docker-registry    ext4    defaults        2 2</span><br></pre></td></tr></table></figure>
<h2 id="4-设置开机自动启动私有镜像仓库"><a href="#4-设置开机自动启动私有镜像仓库" class="headerlink" title="4) 设置开机自动启动私有镜像仓库"></a>4) 设置开机自动启动私有镜像仓库</h2><p>编写docker-registry.service文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Docker Registry</span><br><span class="line">After=network-online.target docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=oneshot</span><br><span class="line"># ExecStart=/usr/bin/docker run -d -p 5000:5000 --privileged=true \</span><br><span class="line">#       -v /opt/docker-registry:/var/lib/registry --name Test-registry registry:2.6.2</span><br><span class="line">ExecStart=/opt/registry-manager.sh start</span><br><span class="line">ExecReload=/opt/registry-manager.sh restart</span><br><span class="line">ExecStop=/opt/registry-manager.sh stop</span><br><span class="line">RemainAfterExit=yes</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<p>-d: 作为daemon进程启动，也就是后台启动</p>
<p>-v: 默认情况下，早期docker会将仓库存放于容器的/tmp/registry目录下，而当前版本docker存放的位置是/var/lib/registry,因此这里我们将我们的外部硬盘/opt/docker-registry挂在到/var/lib/registry目录下。</p>
<p>-p: 前一个5000是host的端口，后一个是容器的端口。这里将容器的5000端口映射到host的5000端口.</p>
<p>/opt/registry-manager.sh代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line"></span><br><span class="line">registry_name=Test-registry</span><br><span class="line"></span><br><span class="line">function docker_registry_start &#123;</span><br><span class="line">    registry_container=`docker ps -a | grep $registry_name`</span><br><span class="line">    </span><br><span class="line">    if [ -z &quot;$registry_container&quot; ]</span><br><span class="line">    then</span><br><span class="line">       /usr/bin/docker run -d -p 5000:5000 --privileged=true  --restart=always -v /opt/docker-registry:/var/lib/registry --name $registry_name registry:2.6.2</span><br><span class="line">    else</span><br><span class="line">       /usr/bin/docker start $registry_name</span><br><span class="line">    fi </span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function docker_registry_stop &#123;</span><br><span class="line">    /usr/bin/docker stop $registry_name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if [ $# -ne 1 ]</span><br><span class="line">then</span><br><span class="line">   echo &quot;invalid parameter number&quot;</span><br><span class="line">   exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ $1 = &quot;start&quot; ]</span><br><span class="line">then</span><br><span class="line">   docker_registry_start</span><br><span class="line">elif [ $1 = &quot;stop&quot; ]</span><br><span class="line">then </span><br><span class="line">    docker_registry_stop</span><br><span class="line">elif [ $1 = &quot;restart&quot; ]</span><br><span class="line">then</span><br><span class="line">    docker_registry_stop</span><br><span class="line">    docker_registry_start</span><br><span class="line">else</span><br><span class="line">    echo &quot;unsupported command&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<p>接下来，将该文件拷贝到/lib/systemd/system/目录下，执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># cp docker-registry.service /lib/systemd/system/</span><br><span class="line"># systemctl daemon-reload</span><br><span class="line"># systemctl enable docker-registry</span><br><span class="line"># sudo journalctl -n 20                          //查看日志</span><br><span class="line"># systemctl status docker-registry.service</span><br></pre></td></tr></table></figure>
<p>这里配置iptables，以允许5000端口：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># iptables -I INPUT 1 -p tcp --dport 5000 -j ACCEPT</span><br><span class="line"></span><br><span class="line"># iptables -L -n -v                                       //可以看到iptables添加成功</span><br><span class="line">Chain INPUT (policy ACCEPT 43 packets, 3432 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line">    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:5000</span><br><span class="line"></span><br><span class="line">//这里iptables配置保存有些问题(service iptables save)，需要安装iptables-services</span><br><span class="line"># sudo yum install --downloadonly --downloaddir=./ iptables-services</span><br><span class="line"># ls</span><br><span class="line">iptables-1.4.21-18.3.el7_4.x86_64.rpm           iptables-services-1.4.21-18.3.el7_4.x86_64.rpm  </span><br><span class="line"></span><br><span class="line"># yum localinstall *.rpm</span><br><span class="line"></span><br><span class="line"># service iptables save</span><br><span class="line"></span><br><span class="line"># systemctl is-active iptables</span><br><span class="line">inactive</span><br><span class="line"># systemctl unmask iptables</span><br><span class="line">Removed symlink /etc/systemd/system/iptables.service.</span><br><span class="line"># systemctl enable iptables</span><br><span class="line">Created symlink from /etc/systemd/system/basic.target.wants/iptables.service to /usr/lib/systemd/system/iptables.service.</span><br></pre></td></tr></table></figure>
<h1 id="3-测试"><a href="#3-测试" class="headerlink" title="3. 测试"></a>3. 测试</h1><h2 id="1-push镜像到私有镜像仓库"><a href="#1-push镜像到私有镜像仓库" class="headerlink" title="1) push镜像到私有镜像仓库"></a>1) push镜像到私有镜像仓库</h2><p>接下来，我们就要操作把一个本地镜像push到私有仓库中。在内网的任意一台装有docker机器下pull一个比较小的镜像来测试（此处使用busybox):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># docker pull busybox</span><br></pre></td></tr></table></figure></p>
<p>然后再修改一下该镜像的tag:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//此处前缀为我们的私有镜像库地址</span><br><span class="line"># docker tag busybox 10.17.153.196:5000/busybox   </span><br><span class="line"></span><br><span class="line"># docker images</span><br><span class="line">REPOSITORY                   TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">10.17.153.196:5000/busybox   latest              f6e427c148a7        9 days ago          1.15MB</span><br><span class="line">busybox                      latest              f6e427c148a7        9 days ago          1.15MB</span><br></pre></td></tr></table></figure></p>
<p>接着再push到我们的私有镜像仓库：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># docker push 10.17.153.196:5000/busybox</span><br><span class="line">The push refers to repository [10.17.153.196:5000/busybox]</span><br><span class="line">Get https://10.17.153.196:5000/v2/: http: server gave HTTP response to HTTPS client</span><br></pre></td></tr></table></figure>
<p>上面我们看到，出现了错误，提示说： 服务端给了一个http响应到客户端。</p>
<h2 id="2）-配置docker以支持http方式push"><a href="#2）-配置docker以支持http方式push" class="headerlink" title="2） 配置docker以支持http方式push"></a>2） 配置docker以支持http方式push</h2><p>之所以出现上面的错误提示，是因为docker从1.3.x之后，与docker registry交互默认使用的是https，然而此处搭建的私有仓库只提供http服务，所以当与私有仓库交互时就会报上面的错误。</p>
<p>这里修改docker的启动配置文件/lib/systemd/system/docker.service，在其中添加:</p>
<p>–insecure-registry=10.17.153.196:5000<br>修改后如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network-online.target firewalld.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line"># the default is not to use systemd for cgroups because the delegate issues still</span><br><span class="line"># exists and systemd currently does not support the cgroup feature set required</span><br><span class="line"># for containers run by docker</span><br><span class="line">ExecStart=/usr/bin/dockerd \</span><br><span class="line">		--insecure-registry=10.17.153.196:5000 \</span><br><span class="line">		-H tcp://0.0.0.0:2375 \ </span><br><span class="line">		-H unix://var/run/docker.sock \ </span><br><span class="line">		-H tcp://0.0.0.0:7654</span><br><span class="line"></span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line"></span><br><span class="line"># Having non-zero Limit*s causes performance problems due to accounting overhead</span><br><span class="line"># in the kernel. We recommend using cgroups to do container-local accounting.</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line"># Uncomment TasksMax if your systemd version supports it.</span><br><span class="line"># Only systemd 226 and above support this version.</span><br><span class="line">#TasksMax=infinity</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line"># set delegate yes so that systemd does not reset the cgroups of docker containers</span><br><span class="line">Delegate=yes</span><br><span class="line"># kill only the docker process, not all processes in the cgroup</span><br><span class="line">KillMode=process</span><br><span class="line"># restart the docker process if it exits prematurely</span><br><span class="line">Restart=on-failure</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<p>修改完成后(注意上面ExecStart分多行写时，前面为tab键)，重启docker，然后再push镜像：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># systemctl daemon-reload &amp;&amp; systemctl restart docker</span><br><span class="line"></span><br><span class="line"># docker push 10.17.153.196:5000/busybox</span><br><span class="line">The push refers to repository [10.17.153.196:5000/busybox]</span><br><span class="line">c5183829c43c: Pushed </span><br><span class="line">latest: digest: sha256:c7b0a24019b0e6eda714ec0fa137ad42bc44a754d9cea17d14fba3a80ccc1ee4 size: 527</span><br></pre></td></tr></table></figure>
<h2 id="3）-查看我们push到私有镜像仓库中的镜像"><a href="#3）-查看我们push到私有镜像仓库中的镜像" class="headerlink" title="3） 查看我们push到私有镜像仓库中的镜像"></a>3） 查看我们push到私有镜像仓库中的镜像</h2><p>登录到私有镜像仓库服务器，查看我们push上去的busybox镜像:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># docker exec -it MyRegistry /bin/sh</span><br><span class="line"></span><br><span class="line"># find / -name busybox</span><br><span class="line">/bin/busybox</span><br><span class="line">/var/lib/registry/docker/registry/v2/repositories/busybox</span><br></pre></td></tr></table></figure>
<p>上面我们看到，我们push上去的busybox镜像存放在/var/lib/registry目录下。</p>
<p>通过curl命令查看当前镜像仓库中的镜像：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># curl -XGET http://10.17.153.196:5000/v2/_catalog  </span><br><span class="line">&#123;&quot;repositories&quot;:[&quot;busybox&quot;]&#125;</span><br><span class="line"></span><br><span class="line"># curl -XGET http://10.17.153.196:5000/v2/busybox/tags/list </span><br><span class="line">&#123;&quot;name&quot;:&quot;busybox&quot;,&quot;tags&quot;:[&quot;latest&quot;]&#125;</span><br></pre></td></tr></table></figure>
<h1 id="4-配置仓库认证"><a href="#4-配置仓库认证" class="headerlink" title="4. 配置仓库认证"></a>4. 配置仓库认证</h1><p>私有仓库搭建以后其他所有客户端均可以push、pull，docker官方提供认证方法对docker仓库进行权限保护.我们这里只添加用户权限限制：</p>
<h2 id="1-删除原来启动的仓库容器"><a href="#1-删除原来启动的仓库容器" class="headerlink" title="1) 删除原来启动的仓库容器"></a>1) 删除原来启动的仓库容器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE                            COMMAND                  CREATED             STATUS                         PORTS                    NAMES</span><br><span class="line">cba959ec5852        registry:2.6.2                   &quot;/entrypoint.sh /etc…&quot;   43 seconds ago      Up 42 seconds                  0.0.0.0:5000-&gt;5000/tcp   Test-registry</span><br><span class="line"></span><br><span class="line"># docker stop Test-registry</span><br><span class="line"># docker rm Test-registry</span><br></pre></td></tr></table></figure>
<h2 id="2-创建存放账号的文件"><a href="#2-创建存放账号的文件" class="headerlink" title="2) 创建存放账号的文件"></a>2) 创建存放账号的文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># mkdir /opt/docker-auth</span><br><span class="line"></span><br><span class="line">//这里添加一个admin账号，密码设置为123</span><br><span class="line"># docker run --entrypoint htpasswd registry:2.6.2 -Bbn admin 123 &gt;&gt; /opt/docker-auth/htpasswd</span><br><span class="line"># cat /opt/docker-auth/htpasswd</span><br><span class="line">admin:$2y$05$AWp/QM9DPRvOgwv9iNjxlO3juhHqj/ANzmxsPvV3nsQBZpcy1x62C</span><br></pre></td></tr></table></figure>
<h2 id="3-修改docker-registry的启动参数，并启动"><a href="#3-修改docker-registry的启动参数，并启动" class="headerlink" title="3) 修改docker registry的启动参数，并启动"></a>3) 修改docker registry的启动参数，并启动</h2><p>这里我们修改上文的registry-manager.sh:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"># cat registry-manager.sh </span><br><span class="line">#!/bin/sh</span><br><span class="line"></span><br><span class="line">registry_name=test-registry</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function docker_registry_start &#123;</span><br><span class="line">    registry_container=`docker ps -a | grep $registry_name`</span><br><span class="line">    </span><br><span class="line">    if [ -z &quot;$registry_container&quot; ]</span><br><span class="line">    then</span><br><span class="line">/usr/bin/docker run -d -p 5000:5000 --privileged=true --restart=always \</span><br><span class="line"> -v /opt/docker-registry:/var/lib/registry -v /opt/docker-auth:/auth \</span><br><span class="line"> -e &quot;REGISTRY_AUTH=htpasswd&quot; \</span><br><span class="line"> -e &quot;REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm&quot; \</span><br><span class="line"> -e REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd \</span><br><span class="line"> --name $registry_name \</span><br><span class="line"> registry:2.6.2</span><br><span class="line">    </span><br><span class="line">    else</span><br><span class="line">       /usr/bin/docker start $registry_name</span><br><span class="line">    fi </span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function docker_registry_stop &#123;</span><br><span class="line">    /usr/bin/docker stop $registry_name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function docker_registry_remove &#123;</span><br><span class="line">    /usr/bin/docker stop $registry_name</span><br><span class="line">    /usr/bin/docker rm $registry_name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if [ $# -ne 1 ]</span><br><span class="line">then</span><br><span class="line">   echo &quot;invalid parameter number&quot;</span><br><span class="line">   exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ $1 = &quot;start&quot; ]</span><br><span class="line">then</span><br><span class="line">   docker_registry_start</span><br><span class="line">elif [ $1 = &quot;stop&quot; ]</span><br><span class="line">then </span><br><span class="line">    docker_registry_stop</span><br><span class="line">elif [ $1 = &quot;restart&quot; ]</span><br><span class="line">then</span><br><span class="line">    docker_registry_stop</span><br><span class="line">    docker_registry_start</span><br><span class="line">elif [ $1 == &quot;remove&quot; ]</span><br><span class="line">then</span><br><span class="line">    docker_registry_remove</span><br><span class="line">else</span><br><span class="line">    echo &quot;unsupported command&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure></p>
<h2 id="4-测试"><a href="#4-测试" class="headerlink" title="4) 测试"></a>4) 测试</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># docker pull 10.17.153.196:5000/busybox</span><br><span class="line">Using default tag: latest</span><br><span class="line">Error response from daemon: Get http://10.17.153.196:5000/v2/busybox/manifests/latest: no basic auth credentials</span><br><span class="line"></span><br><span class="line"># docker login http://10.17.153.196:5000 </span><br><span class="line">Username: admin</span><br><span class="line">Password: </span><br><span class="line">Login Succeeded</span><br><span class="line"></span><br><span class="line"># docker pull  10.17.153.196:5000/busybox</span><br><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from busybox</span><br><span class="line">d070b8ef96fc: Pull complete </span><br><span class="line">Digest: sha256:c7b0a24019b0e6eda714ec0fa137ad42bc44a754d9cea17d14fba3a80ccc1ee4</span><br></pre></td></tr></table></figure></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">GuoJing</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yoursite.com/2018/11/25/docker环境的搭建-离线安装/">http://yoursite.com/2018/11/25/docker环境的搭建-离线安装/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/docker/">docker</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/11/25/python实现FTP服务器/"><i class="fa fa-chevron-left">  </i><span>python实现FTP服务器</span></a></div><div class="next-post pull-right"><a href="/2018/11/25/对称、非对称加密算，openssl生成证书（笔记）/"><span>对称、非对称加密算，openssl生成证书（笔记）</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '0acc1c951d3dc1bf9b59',
  clientSecret: '41718c817e6a78695cefaa40fa7d1c4d43c307a3',
  repo: 'https://github.com/Gavin-J/Gavin-J.github.io',
  owner: 'Gavin-J',
  admin: 'Gavin-J',
  id: md5(decodeURI(location.pathname)),
  language: ''
})
gitalk.render('gitalk-container')</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2018 By GuoJing</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://www.evali.cn">blog</a>!</div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script></body></html>